<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX Consolidation Dashboard | IAS 21 Sim</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom scrollbar for table container - Dark Mode */
        .scroller::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .scroller::-webkit-scrollbar-track {
            background: #0f172a; /* Slate 900 */
        }
        .scroller::-webkit-scrollbar-thumb {
            background: #334155; /* Slate 700 */
            border-radius: 4px;
        }
        .scroller::-webkit-scrollbar-thumb:hover {
            background: #475569; /* Slate 600 */
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen flex flex-col selection:bg-emerald-500 selection:text-white">

    <!-- Navigation -->
    <nav class="bg-slate-900 border-b border-slate-800 shadow-lg z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-chart-line text-emerald-500 text-xl"></i>
                    <span class="font-semibold text-lg tracking-tight text-white">FinConsolidate <span class="text-slate-500 text-sm font-normal">| IAS 21 Engine</span></span>
                </div>
                <div class="text-xs text-slate-500 hidden sm:block">
                    Entity: US_SUB_01 (USD) &rarr; Group (GBP)
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        
        <!-- Controls & Rate Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Rate Control Panel -->
            <div class="bg-slate-900 p-6 rounded-xl shadow-sm border border-slate-800 lg:col-span-1">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Exchange Rate (USD/GBP)</h2>
                        <div class="text-xs text-slate-500 mt-1" id="rate-source-label">Fetching live rate...</div>
                    </div>
                    <span id="rate-badge" class="px-2 py-1 text-xs font-bold rounded bg-blue-900/30 text-blue-400 border border-blue-900/50">LIVE</span>
                </div>

                <div class="flex items-center gap-4 mb-6">
                    <div class="relative w-full">
                        <input type="number" id="rate-input" step="0.0001" class="w-full text-3xl font-bold text-white border-b-2 border-slate-700 focus:border-emerald-500 outline-none pb-2 bg-transparent transition-colors" value="0.7500">
                        <label class="absolute right-0 bottom-2 text-slate-500 text-sm">GBP</label>
                    </div>
                </div>

                <!-- Sensitivity Slider -->
                <div class="mb-4">
                    <label class="flex justify-between text-xs font-medium text-slate-400 mb-2">
                        <span>Sensitivity Analysis (Override)</span>
                        <span id="variance-percent" class="text-slate-500">0%</span>
                    </label>
                    <input type="range" id="rate-slider" min="0.5" max="1.0" step="0.001" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                    <div class="flex justify-between text-[10px] text-slate-600 mt-1">
                        <span>0.50</span>
                        <span>1.00</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button id="reset-btn" class="flex-1 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm font-medium rounded-lg transition-colors border border-slate-700">
                        Reset to Live
                    </button>
                    <button onclick="fetchLiveRate()" class="p-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg transition-colors border border-slate-700" title="Refresh API">
                        <i class="fa-solid fa-sync"></i>
                    </button>
                </div>
                
                <div class="mt-4 pt-4 border-t border-slate-800 text-xs text-slate-500">
                    <strong>Budget Rate:</strong> <span id="budget-rate-display">0.7800</span> GBP
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
                <!-- Revenue Card -->
                <div class="bg-slate-900 p-6 rounded-xl shadow-sm border border-slate-800 flex flex-col justify-between relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i class="fa-solid fa-building-columns text-6xl text-emerald-500"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-400">Consolidated Revenue</p>
                        <h3 class="text-2xl font-bold text-white mt-1" id="kpi-revenue">£0.00</h3>
                    </div>
                    <div class="mt-4 flex items-center gap-2 text-sm" id="var-revenue-container">
                        <span id="var-revenue-badge" class="px-1.5 py-0.5 rounded font-medium bg-emerald-900/30 text-emerald-400 border border-emerald-900/50">
                            +0.0%
                        </span>
                        <span class="text-slate-500">vs Budget</span>
                    </div>
                </div>

                <!-- Opex Card -->
                <div class="bg-slate-900 p-6 rounded-xl shadow-sm border border-slate-800 flex flex-col justify-between relative overflow-hidden group">
                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i class="fa-solid fa-file-invoice-dollar text-6xl text-rose-500"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-400">Consolidated Opex</p>
                        <h3 class="text-2xl font-bold text-white mt-1" id="kpi-opex">£0.00</h3>
                    </div>
                    <div class="mt-4 flex items-center gap-2 text-sm" id="var-opex-container">
                        <span id="var-opex-badge" class="px-1.5 py-0.5 rounded font-medium bg-slate-800 text-slate-400 border border-slate-700">
                            0.0%
                        </span>
                        <span class="text-slate-500">vs Budget</span>
                    </div>
                </div>

                <!-- Net Profit Card -->
                <div class="bg-slate-800 p-6 rounded-xl shadow-md border border-slate-700 flex flex-col justify-between relative overflow-hidden text-white">
                    <div class="absolute right-0 top-0 p-4 opacity-10">
                        <i class="fa-solid fa-coins text-6xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-400">Net Income (GBP)</p>
                        <h3 class="text-2xl font-bold mt-1 text-emerald-400" id="kpi-profit">£0.00</h3>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-slate-900 rounded-full h-1.5 mb-2">
                            <div id="margin-bar" class="bg-emerald-500 h-1.5 rounded-full" style="width: 45%"></div>
                        </div>
                        <p class="text-xs text-slate-400 flex justify-between">
                            <span>Margin</span>
                            <span id="kpi-margin" class="text-white font-mono">0%</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts & Data Table Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Charts Section -->
            <div class="space-y-6">
                <!-- P&L Breakdown Chart -->
                <div class="bg-slate-900 p-5 rounded-xl shadow-sm border border-slate-800">
                    <h3 class="text-sm font-semibold text-slate-300 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-chart-pie text-slate-500"></i> P&L Breakdown (GBP)
                    </h3>
                    <div class="h-64 relative w-full">
                        <canvas id="plChart"></canvas>
                    </div>
                </div>

                <!-- FX Variance Bridge -->
                <div class="bg-slate-900 p-5 rounded-xl shadow-sm border border-slate-800">
                    <h3 class="text-sm font-semibold text-slate-300 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-bridge text-slate-500"></i> FX Impact Analysis
                    </h3>
                    <p class="text-xs text-slate-500 mb-2">Impact of rate deviation from budget on Net Income.</p>
                    <div class="h-48 relative w-full flex items-center justify-center">
                        <canvas id="varianceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Ledger Table -->
            <div class="bg-slate-900 rounded-xl shadow-sm border border-slate-800 flex flex-col h-[600px] lg:h-auto">
                <div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900 rounded-t-xl">
                    <h3 class="text-sm font-semibold text-slate-300">US Subsidiary Ledger (Trial Balance)</h3>
                    <span class="text-xs font-mono bg-slate-800 border border-slate-700 px-2 py-1 rounded text-slate-400">Source: ERP_API_V2</span>
                </div>
                
                <!-- Table Header -->
                <div class="grid grid-cols-12 gap-2 px-6 py-3 bg-slate-900/50 text-xs font-semibold text-slate-500 border-b border-slate-800">
                    <div class="col-span-4">Account</div>
                    <div class="col-span-3 text-right">USD Actuals</div>
                    <div class="col-span-3 text-right">GBP Consol</div>
                    <div class="col-span-2 text-right">Var %</div>
                </div>

                <!-- Table Body -->
                <div class="overflow-y-auto flex-grow scroller px-2">
                    <div id="ledger-body" class="divide-y divide-slate-800">
                        <!-- Rows injected via JS -->
                    </div>
                </div>
                
                <div class="p-4 border-t border-slate-800 bg-slate-900 rounded-b-xl text-xs text-center text-slate-500">
                    IAS 21: Monetary items translated at closing rate. Non-monetary at historical (simplified to Spot for demo).
                </div>
            </div>

        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 border-t border-slate-800 mt-auto py-6">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-sm text-slate-500">FX Consolidation Simulator</p>
            <p class="text-xs text-slate-600 mt-1">
                Zero-dependency architecture. Data processed locally in browser.
            </p>
        </div>
    </footer>

    <!-- Application Logic -->
    <script>
        // --- Configuration & State ---
        const config = {
            budgetRate: 0.78, // Budgeted Rate (GBP per 1 USD)
            defaultRate: 0.79, // Fallback if API fails
            apiEndpoint: 'https://api.exchangerate-api.com/v4/latest/USD'
        };

        // Dark mode chart defaults
        Chart.defaults.color = '#94a3b8'; // slate-400
        Chart.defaults.borderColor = '#1e293b'; // slate-800
        Chart.defaults.font.family = 'Inter';

        const state = {
            liveRate: null,
            activeRate: null,
            isManual: false,
            // UPDATED DATA: Millions scale (e.g., 150,000,000)
            ledger: [
                // Revenue
                { code: '4000', name: 'Software Sales', type: 'REV', usd: 150000000 },
                { code: '4100', name: 'Consulting Services', type: 'REV', usd: 45000000 },
                { code: '4200', name: 'Support Contracts', type: 'REV', usd: 22000000 },
                // OPEX
                { code: '6000', name: 'Salaries & Wages', type: 'EXP', usd: 85000000 },
                { code: '6100', name: 'Cloud Infrastructure', type: 'EXP', usd: 12000000 },
                { code: '6200', name: 'Marketing & Ads', type: 'EXP', usd: 18000000 },
                { code: '6300', name: 'Rent & Utilities', type: 'EXP', usd: 4500000 },
                { code: '6400', name: 'Travel & Ent', type: 'EXP', usd: 3500000 },
                { code: '6500', name: 'Legal & Professional', type: 'EXP', usd: 1500000 },
                { code: '7000', name: 'Depreciation', type: 'EXP', usd: 6500000 },
            ]
        };

        // --- Chart Instances ---
        let plChartInstance = null;
        let varianceChartInstance = null;

        // --- DOM Elements ---
        const els = {
            rateInput: document.getElementById('rate-input'),
            rateSlider: document.getElementById('rate-slider'),
            rateBadge: document.getElementById('rate-badge'),
            sourceLabel: document.getElementById('rate-source-label'),
            resetBtn: document.getElementById('reset-btn'),
            budgetDisplay: document.getElementById('budget-rate-display'),
            ledgerBody: document.getElementById('ledger-body'),
            // KPIs
            revKpi: document.getElementById('kpi-revenue'),
            opexKpi: document.getElementById('kpi-opex'),
            profitKpi: document.getElementById('kpi-profit'),
            marginKpi: document.getElementById('kpi-margin'),
            marginBar: document.getElementById('margin-bar'),
            // Badges
            revBadge: document.getElementById('var-revenue-badge'),
            opexBadge: document.getElementById('var-opex-badge'),
            varPercent: document.getElementById('variance-percent')
        };

        // --- Formatting Utils ---
        // Compact notation for millions (e.g., £150M) to save space in tables, or full currency for KPIs
        const fmtGBP = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const fmtUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const fmtCompactGBP = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', notation: 'compact' });
        const fmtCompactUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', notation: 'compact' });
        const fmtPct = new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 1 });

        // --- Core Logic ---

        async function init() {
            els.budgetDisplay.textContent = config.budgetRate.toFixed(4);
            
            // Initialize Charts
            initCharts();

            // Try Fetch Live Rate
            await fetchLiveRate();

            // Listeners
            els.rateInput.addEventListener('input', handleRateInput);
            els.rateSlider.addEventListener('input', handleSliderInput);
            els.resetBtn.addEventListener('click', resetToLive);
        }

        async function fetchLiveRate() {
            try {
                els.sourceLabel.textContent = "Connecting to Exchange... 1.05ms";
                const response = await fetch(config.apiEndpoint);
                const data = await response.json();
                
                if (data && data.rates && data.rates.GBP) {
                    state.liveRate = data.rates.GBP;
                    els.sourceLabel.textContent = `Source: ExchangeRate-API (Updated ${new Date(data.date).toLocaleDateString()})`;
                } else {
                    throw new Error("Invalid Data");
                }
            } catch (err) {
                console.warn("API Error, using default", err);
                state.liveRate = config.defaultRate;
                els.sourceLabel.textContent = "Source: Offline Fallback Mode";
            }
            
            resetToLive();
        }

        function resetToLive() {
            state.isManual = false;
            updateRate(state.liveRate);
            els.rateBadge.textContent = "LIVE";
            els.rateBadge.className = "px-2 py-1 text-xs font-bold rounded bg-blue-900/30 text-blue-400 border border-blue-900/50";
            els.varPercent.textContent = "0%";
        }

        function handleRateInput(e) {
            const val = parseFloat(e.target.value);
            if (!isNaN(val)) {
                manualOverride(val);
            }
        }

        function handleSliderInput(e) {
            const val = parseFloat(e.target.value);
            manualOverride(val);
        }

        function manualOverride(rate) {
            state.isManual = true;
            els.rateBadge.textContent = "MANUAL";
            els.rateBadge.className = "px-2 py-1 text-xs font-bold rounded bg-amber-900/30 text-amber-500 border border-amber-900/50";
            
            // Calculate deviation from live
            const diff = ((rate - state.liveRate) / state.liveRate) * 100;
            els.varPercent.textContent = (diff > 0 ? "+" : "") + diff.toFixed(1) + "% vs Live";
            
            updateRate(rate);
        }

        function updateRate(rate) {
            state.activeRate = rate;
            
            // Sync Inputs
            els.rateInput.value = rate.toFixed(4);
            els.rateSlider.value = rate;

            recalculate();
        }

        function recalculate() {
            // 1. Calculate Aggregates
            let totalRevUSD = 0;
            let totalExpUSD = 0;

            // Generate row data
            const rows = state.ledger.map(item => {
                const gbpActual = item.usd * state.activeRate;
                const gbpBudget = item.usd * config.budgetRate;
                const variance = gbpActual - gbpBudget;
                const varPct = (variance / gbpBudget);

                if (item.type === 'REV') totalRevUSD += item.usd;
                if (item.type === 'EXP') totalExpUSD += item.usd;

                return { ...item, gbpActual, gbpBudget, variance, varPct };
            });

            // 2. Summary Figures
            const totalRevGBP = totalRevUSD * state.activeRate;
            const totalExpGBP = totalExpUSD * state.activeRate;
            const netProfitGBP = totalRevGBP - totalExpGBP;
            const margin = (netProfitGBP / totalRevGBP);

            const budgetRevGBP = totalRevUSD * config.budgetRate;
            const budgetExpGBP = totalExpUSD * config.budgetRate;
            
            // 3. Render DOM
            renderKPIs(totalRevGBP, totalExpGBP, netProfitGBP, margin, budgetRevGBP, budgetExpGBP);
            renderTable(rows);
            updateChartData(totalRevGBP, totalExpGBP, netProfitGBP, totalRevUSD, totalExpUSD);
        }

        function renderKPIs(rev, exp, profit, margin, budgetRev, budgetExp) {
            // Use compact format for very large numbers if they break layout, 
            // but standard currency usually fine for KPIs if space allows.
            els.revKpi.textContent = fmtCompactGBP.format(rev);
            els.opexKpi.textContent = fmtCompactGBP.format(exp);
            els.profitKpi.textContent = fmtCompactGBP.format(profit);
            
            els.marginKpi.textContent = fmtPct.format(margin);
            els.marginBar.style.width = `${Math.max(0, Math.min(100, margin * 100))}%`;

            // Variance badges
            const revVar = (rev - budgetRev) / budgetRev;
            const expVar = (exp - budgetExp) / budgetExp;

            els.revBadge.textContent = (revVar > 0 ? "+" : "") + fmtPct.format(revVar);
            els.revBadge.className = `px-1.5 py-0.5 rounded font-medium border ${revVar >= 0 ? 'bg-emerald-900/30 text-emerald-400 border-emerald-900/50' : 'bg-rose-900/30 text-rose-400 border-rose-900/50'}`;

            // Expense variance
            els.opexBadge.textContent = (expVar > 0 ? "+" : "") + fmtPct.format(expVar);
            els.opexBadge.className = `px-1.5 py-0.5 rounded font-medium border ${expVar <= 0 ? 'bg-emerald-900/30 text-emerald-400 border-emerald-900/50' : 'bg-rose-900/30 text-rose-400 border-rose-900/50'}`;
        }

        function renderTable(rows) {
            els.ledgerBody.innerHTML = rows.map(row => {
                const isGood = row.type === 'REV' ? row.varPct >= 0 : row.varPct <= 0;
                const colorClass = isGood ? 'text-emerald-500' : 'text-rose-500';
                
                return `
                <div class="grid grid-cols-12 gap-2 px-6 py-3 hover:bg-slate-800 transition-colors group text-sm items-center">
                    <div class="col-span-4 flex flex-col">
                        <span class="font-medium text-slate-300">${row.name}</span>
                        <span class="text-[10px] text-slate-500 font-mono">GL-${row.code}</span>
                    </div>
                    <div class="col-span-3 text-right font-mono text-slate-400 text-xs">${fmtCompactUSD.format(row.usd)}</div>
                    <div class="col-span-3 text-right font-mono font-medium text-slate-200">${fmtCompactGBP.format(row.gbpActual)}</div>
                    <div class="col-span-2 text-right">
                        <span class="${colorClass} text-xs font-bold bg-slate-800 border border-slate-700 px-2 py-1 rounded shadow-sm">
                            ${(row.varPct * 100).toFixed(1)}%
                        </span>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- Chart.js Setup ---

        function initCharts() {
            // 1. P&L Pie
            const ctxPl = document.getElementById('plChart').getContext('2d');
            plChartInstance = new Chart(ctxPl, {
                type: 'doughnut',
                data: {
                    labels: ['Revenue', 'Opex', 'Net Profit'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#10b981', '#f43f5e', '#334155'], // emerald, rose, slate
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 6 } }
                    }
                }
            });

            // 2. Variance Bridge (Bar)
            const ctxVar = document.getElementById('varianceChart').getContext('2d');
            varianceChartInstance = new Chart(ctxVar, {
                type: 'bar',
                data: {
                    labels: ['Budget Net', 'FX Impact', 'Actual Net'],
                    datasets: [{
                        label: 'GBP Value',
                        data: [0, 0, 0],
                        backgroundColor: (ctx) => {
                            const v = ctx.raw;
                            if(ctx.dataIndex === 1) return v >= 0 ? '#10b981' : '#f43f5e';
                            return '#475569'; // slate-600
                        },
                        borderRadius: 4,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return fmtCompactGBP.format(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false }, ticks: { callback: (val) => fmtCompactGBP.format(val) } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateChartData(rev, exp, profit, revUSD, expUSD) {
            // Update Pie
            plChartInstance.data.datasets[0].data = [rev, exp, profit];
            plChartInstance.update();

            // Update Bridge
            // Calculate Budget Net Income
            const budgetNet = (revUSD * config.budgetRate) - (expUSD * config.budgetRate);
            const actualNet = profit;
            const fxImpact = actualNet - budgetNet;

            varianceChartInstance.data.datasets[0].data = [budgetNet, fxImpact, actualNet];
            
            // Color logic for last bar
            const colors = ['#64748b', (fxImpact >= 0 ? '#10b981' : '#f43f5e'), '#e2e8f0'];
            varianceChartInstance.data.datasets[0].backgroundColor = colors;
            
            varianceChartInstance.update();
        }

        // Run on load
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
